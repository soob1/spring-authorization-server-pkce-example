<!doctype html>
<html>
<head><meta charset="utf-8"><title>PKCE Callback</title></head>
<body>
<h1>Callback</h1>
<pre id="out"></pre>

<script type="module">
    import { exchangeToken } from "./pkce.js";

    const out = document.getElementById("out");
    const params = new URLSearchParams(location.search);
    const code = params.get("code");
    const state = params.get("state");
    const error = params.get("error");

    if (error) {
        out.textContent = "error: " + error + "\n" + params.toString();
        throw new Error(error);
    }

    const savedState = sessionStorage.getItem("oauth_state");
    const verifier = sessionStorage.getItem("pkce_verifier");

    if (!code) throw new Error("missing code");
    if (!verifier) throw new Error("missing pkce_verifier");
    if (state !== savedState) throw new Error("state mismatch");

    out.textContent = "code received\nexchanging token...\n";

    const token = await exchangeToken({ code, verifier });
    out.textContent = JSON.stringify(token, null, 2);
</script>
</body>
</html>
